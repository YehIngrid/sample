<!-- index.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商品列表範例</title>
  <style>
    body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; margin:0; padding:0; background:#e6e6e6; }
    .topbar { background:#1f63a6; color:#fff; padding:12px 16px; }
    .container { display:flex; gap:20px; padding:20px; }
    .sidebar { width:220px; background:#fff; padding:12px; border-radius:4px; box-shadow:0 0 0 1px rgba(0,0,0,0.05); }
    .hidden { display:none !important; }
    .main { flex:1; }
    .filters { margin-bottom:16px; }
    .filters button { margin-right:8px; padding:8px 12px; cursor:pointer; }
    .products { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:16px; }
    .product-card { background:#fff; height:200px; padding:12px; border-radius:6px; box-shadow:0 1px 0 rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:center; }
    .loader { text-align:center; padding:12px; color:#666; }
    /* 偵測點不需要顯示 */
    #loadMoreTrigger { height:1px; }
  </style>
</head>
<body>

  <div class="topbar">
    <strong>我的購物網站</strong>
  </div>

  <div style="padding:12px 20px;">
    <!-- 分類按鈕 -->
    <div class="filters">
      <button onclick="changeCategory('all')">全部商品</button>
      <button onclick="changeCategory('books')">書籍與學籍用品</button>
      <button onclick="changeCategory('clothes')">服飾</button>
      <button onclick="changeCategory('food')">食品</button>
    </div>

    <div class="container">
      <aside id="sidebar" class="sidebar hidden">
        <h4>品項分類</h4>
        <ul id="categoryList"></ul>
      </aside>

      <main class="main">
        <div id="productContainer" class="products"></div>

        <div id="loader" class="loader">載入中...</div>
        <!-- 這是 IntersectionObserver 的觸發點 -->
        <div id="loadMoreTrigger"></div>
      </main>
    </div>
  </div>

<script>
/*
  整體邏輯：
  - currentCategory: 當前分類（'all' 表示全部）
  - page: 當前頁數（從 0 開始）
  - pageSize: 每頁顯示數量（題目要 18）
  - isLoading / isAllLoaded: 避免重複請求
*/

// ——— 初始參數 ———
let currentCategory = 'all';
let page = 0;
const pageSize = 18;
let isLoading = false;
let isAllLoaded = false;

// DOM 元件
const sidebar = document.getElementById('sidebar');
const categoryList = document.getElementById('categoryList');
const productContainer = document.getElementById('productContainer');
const loader = document.getElementById('loader');
const loadMoreTrigger = document.getElementById('loadMoreTrigger');

// 範例：每個分類對應的 sidebar 子分類
const categoryItems = {
  books: ['課本', '參考書', '文具', '教材', '雜誌'],
  clothes: ['上衣', '褲子', '外套', '配件'],
  food: ['零食', '飲料', '生鮮', '熟食']
};

// 這裡模擬一筆完整資料庫（實際請用後端 API）
const allMockProducts = generateMockProducts(200); // 總共 200 筆示範資料

function generateMockProducts(n) {
  const cats = ['books','clothes','food','home','electronics'];
  const arr = [];
  for (let i=1;i<=n;i++){
    const c = cats[i % cats.length];
    arr.push({
      id: i,
      title: `${c.toUpperCase()} 品項 ${i}`,
      category: c
    });
  }
  return arr;
}

// ——— 改分類時呼叫 ———
function changeCategory(category) {
  currentCategory = category;
  page = 0;
  isAllLoaded = false;
  productContainer.innerHTML = '';
  setSidebarByCategory(category);
  loadProducts(); // 載入第一頁
}

// 控制 sidebar 顯示/隱藏以及內容
function setSidebarByCategory(category) {
  if (category === 'all') {
    sidebar.classList.add('hidden');
  } else {
    sidebar.classList.remove('hidden');
    // 塞入該分類的項目
    const items = categoryItems[category] || ['其他'];
    categoryList.innerHTML = items.map(i => `<li><a href="#" onclick="filterBySub('${i}')">${i}</a></li>`).join('');
  }
}

// 當 user 點 sidebar 的子分類（範例：會做 client-side 篩選）
function filterBySub(sub) {
  // 如果你想把子分類傳給後端做更精細的分頁，改成呼叫 API 並帶 sub。
  // 這裡示範只顯示一個 alert 與重新載入（可自行實作）
  alert(`你點了子分類：${sub}\n請改成呼叫後端以 sub 作篩選（示範）`);
}

// ——— 載入商品（會呼叫後端或模擬資料） ———
async function loadProducts() {
  if (isLoading || isAllLoaded) return;
  isLoading = true;
  loader.textContent = '載入中...';

  // 呼叫後端 / 模擬資料
  try {
    const data = await fetchProductsFromServer(currentCategory, page, pageSize);
    // data.items: 商品陣列； data.totalCount: 總筆數（可選）
    if (!data || data.items.length === 0) {
      isAllLoaded = true;
      loader.textContent = '沒有更多商品了';
    } else {
      renderProducts(data.items);
      page++; // 下一頁
      // 如果已經載完所有項目，也可以透過 totalCount 判斷
      if (data.items.length < pageSize) {
        isAllLoaded = true;
        loader.textContent = '沒有更多商品了';
      } else {
        loader.textContent = '向下滾動以載入更多';
      }
    }
  } catch (err) {
    console.error(err);
    loader.textContent = '載入失敗，請稍後再試';
  } finally {
    isLoading = false;
  }
}

// 將商品加入畫面
function renderProducts(items) {
  items.forEach(p => {
    const el = document.createElement('div');
    el.className = 'product-card';
    el.innerHTML = `<div>
      <div style="font-size:14px; margin-bottom:6px;">${p.title}</div>
      <div style="font-size:12px; color:#666;">類別：${p.category}</div>
    </div>`;
    productContainer.appendChild(el);
  });
}

// ——— 模擬後端 / 分頁 API ——
// 你要把這個改成 fetch('/api/products?category=books&page=0&pageSize=18')...
// 回傳格式要包含 items 陣列，最好也回 totalCount
function fetchProductsFromServer(category, pageIdx, pageSize) {
  return new Promise((resolve) => {
    // 模擬網路延遲
    setTimeout(() => {
      // 篩選資料
      let pool;
      if (category === 'all') {
        pool = allMockProducts;
      } else {
        pool = allMockProducts.filter(p => p.category === category);
      }
      const start = pageIdx * pageSize;
      const items = pool.slice(start, start + pageSize);
      resolve({ items, totalCount: pool.length });
    }, 400); // 模擬 400ms 延遲
  });
}

// ——— IntersectionObserver：當觸發點進入畫面時載入下一頁 ———
const io = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      loadProducts();
    }
  });
}, {
  root: null,
  rootMargin: '0px',
  threshold: 0.1
});
io.observe(loadMoreTrigger);

// ——— 頁面載入時先顯示「全部商品」第一頁 ———
document.addEventListener('DOMContentLoaded', () => {
  changeCategory('all');
});
</script>
</body>
</html>
